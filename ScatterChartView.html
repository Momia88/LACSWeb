<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Charts</title>

		<link href="css/bootstrap.css" rel="stylesheet">
		<link href="css/styles.css" rel="stylesheet">
		<link href="css/jquery-ui.css" rel="stylesheet">
		<link href="css/loading.css" rel="stylesheet">

		<script src="js/jquery-3.1.1.min.js"></script>
		<script src="js/jquery-ui.js"></script>
		<script src="js/math.min.js"></script>
		<script src="js/Chart.js"></script>
		<script src="js/jspdf.min.js"></script>
		<script src="js/Variables.js"></script>

		<!--Icons-->
		<script src="js/lumino.glyphs.js"></script>

		<style type="text/css">
			#chartInfo {
				margin: 15px;
			}

			canvas {
				background-color: #FFFFFF;
				background: #FFFFFF;
				height: "200";
				width: "600";
			}

			input {
				margin: 5px;
				padding-left: 10px;
				padding-right: 10px;
				padding-top: 5px;
				padding-bottom: 5px;
			}
		</style>

	</head>

	<body>
		<div id="loading" style="display: none"></div>

		<nav class="navbar navbar-inverse navbar-fixed-top">
			<a class="navbar-brand" href="#">LACS DashBoard</a>
			<ul class="user-menu">
				<li class="dropdown pull-right">
					<a href="index.html">Logout</a>
				</li>
			</ul>
		</nav>

		<div id="sidebar-collapse" class="col-sm-3 col-lg-2 sidebar"></div>
		<script>
			$(function() {
				$("#sidebar-collapse").load("Menu.html");
			});
		</script>
		<!--/.sidebar-->

		<div class="col-sm-9 col-sm-offset-3 col-lg-10 col-lg-offset-2 main">
			<div class="row">
				<div id="chartInfo">
					<form action=scatterView.html method="post">
						<label>日期查詢：</label>
						<input type="text" id="startdatepicker"
						required="required">
						~
						<input type="text"
						id="enddatepicker" required="required">
						<br />
						<label>Model
							Type:</label>
						<input type="text" id="modelType" required="required">
						<label>Chart Type :</label>
						<select id="chartType"
						required="required">
							<option value="white_color">White center</option>
							<option value="red_color">Red center</option>
							<option value="green_color">Green center</option>
							<option value="blue_color">Blue center</option>
						</select>
						<br />
						<label>上限: </label>
						<input type="text" id="uslValue">
						<label>下限:</label>
						<input type="text" id="lslValue">
						<label>標準:</label>
						<input
						type="text" id="specValue">
						<input onclick="saveData()"
						type="submit" id="sumitBtn" value="提交" />
					</form>
				</div>
			</div>
			<!--/.row-->

			<div class="row">
				<div class="col-lg-12">
					<div class="panel panel-default">
						<div class="panel-heading">
							Bar Chart
						</div>
						<div id="chart-content" class="panel-body">
							<div id="panel" class="canvas-wrapper">
								<canvas id="bar-chart" class="main-chart"></canvas>
							</div>
						</div>
					</div>
				</div>
			</div>
			<button type="button" id="download-pdf">
				Download PDF
			</button>
			<!--/.row-->
		</div>
		<!--/.main-->
		<script type="text/javascript">
			//donwload pdf from original canvas
			function downloadPDF() {
				var canvas = document.querySelector('#bar-chart');
				//creates image
				var canvasImg = canvas.toDataURL("image/jpeg", 1.0);

				//creates PDF from img
				var doc = new jsPDF('landscape');
				doc.setFontSize(20);
				doc.text(15, 15, "Bar Chart");
				doc.addImage(canvasImg, 'PNG', 10, 10, 280, 150);
				doc.save('canvas.pdf');
			}

			//add event listener to 2nd button
			document.getElementById('download-pdf').addEventListener("click", downloadPDF);
		</script>
		<script>
			$(function() {
				$("#startdatepicker").datepicker({
					dateFormat : 'yy-mm-dd'
				});
				$("#enddatepicker").datepicker({
					dateFormat : 'yy-mm-dd'
				});
			});
		</script>
		<script src="js/ChartConfig.js"></script>
		<script src="js/Utils.js"></script>
		<script src="js/bubbleChart.js"></script>
		<script>
			function saveData() {
				var _mType = document.getElementById("modelType").value;
				var _cType = document.getElementById("chartType").value;
				var _sTime = document.getElementById("startdatepicker").value;
				var _eTime = document.getElementById("enddatepicker").value;
				// 平均線位置
				var _uslValue = document.getElementById("uslValue").value;
				var _lslValue = document.getElementById("lslValue").value;
				var _specValue = document.getElementById("specValue").value;

				sessionStorage.setItem('mType', _mType);
				sessionStorage.setItem('cType', _cType);
				sessionStorage.setItem('sTime', _sTime);
				sessionStorage.setItem('eTime', _eTime);
				sessionStorage.setItem('uslValue', _uslValue);
				sessionStorage.setItem('lslValue', _lslValue);
				sessionStorage.setItem('specValue', _specValue);

			}


			window.onload = function() {
				// init params
				var mType = sessionStorage.getItem("mType");
				var cType = sessionStorage.getItem("cType");
				var sTime = sessionStorage.getItem("sTime");
				var eTime = sessionStorage.getItem("eTime");
				var uslValue = sessionStorage.getItem("uslValue");
				var lslValue = sessionStorage.getItem("lslValue");
				var specValue = sessionStorage.getItem("specValue");

				document.getElementById("modelType").value = mType;
				document.getElementById("chartType").value = cType;
				document.getElementById("startdatepicker").value = sTime;
				document.getElementById("enddatepicker").value = eTime;
				document.getElementById("uslValue").value = uslValue;
				document.getElementById("lslValue").value = lslValue;
				document.getElementById("specValue").value = specValue;

				var titleStr = mType + sTime + " - " + eTime;
				var s = new Date(sTime);
				var e = new Date(eTime);
				if (s.dateDiff("m", e) > 12 || s.dateDiff("m", e) == null) {
					alert("日期錯誤或超過12個月!");
					return;
				}

				var randomScalingFactor = function() {
					return (Math.random() > 0.5 ? 1.0 : -1.0) * Math.round(Math.random() * 100);
				};
				var randomColorFactor = function() {
					return Math.round(Math.random() * 255);
				};

				var brightAvg = function(list) {
					var sum = 0;
					for (var i = 0; i < list.length; i++) {
						sum += list[i];
					}
					var avg = sum / list.length;
					return parseInt(avg);
				};

				Date.prototype.dateDiff = function(interval, objDate) {
					var dtEnd = new Date(objDate);
					if (isNaN(dtEnd))
						return null;
					switch (interval) {
					case "s":
						return parseInt((dtEnd - this) / 1000);
					case "n":
						return parseInt((dtEnd - this) / 60000);
					case "h":
						return parseInt((dtEnd - this) / 3600000);
					case "d":
						return parseInt((dtEnd - this) / 86400000);
					case "w":
						return parseInt((dtEnd - this) / (86400000 * 7));
					case "m":
						return (dtEnd.getMonth() + 1) + ((dtEnd.getFullYear() - this.getFullYear()) * 12) - (this.getMonth() + 1);
					case "y":
						return dtEnd.getFullYear() - this.getFullYear();
					}
				};

				jsonData = $.ajax({
					// url :
					url : serverIP + '/service/color',
					type : "POST",
					data : {
						modelType : mType,
						chartType : cType,
						startTime : sTime,
						endTime : eTime
					},
					dataType : 'json',
					success : function(chartJsonData) {
						// Split timestamp and data into
						// separate arrays
						var barLebels = chartJsonData.xLabels;
						var barValues = chartJsonData.yValues;

						// bar color
						var r = 0;
						var g = 0;
						var b = 0;
						var backColor = [];
						var borderColor = [];
						for (var i = 0; i < barLebels.length; i++) {
							r = randomColorFactor();
							g = randomColorFactor();
							b = randomColorFactor();
							backColor.push('rgba(' + r + "," + g + "," + b + ",0.5)");
							borderColor.push('rgba(' + r + "," + g + "," + b + ",1)");
						}

						// insert html value
						var maxValue = chartJsonData.maxValue;
						var minValue = chartJsonData.minValue;
						var avgValue = chartJsonData.avgValue;
						var stdValue = chartJsonData.stdValue;

						// Chart Setting
						var avgIndex = (avgValue - minValue) / (maxValue - minValue) * 10 + 2;

						var bubbleData = {
							datasets : [{
								label : 'First Dataset',
								data : [{
									x : 0.2938,
									y : 0.3130,
									r : 2
								}, {
									x : 0.2931,
									y : 0.3123,
									r : 2
								}, {
									x : 0.2999,
									y : 0.3220,
									r : 2
								}, {
									x : 0.2946,
									y : 0.3129,
									r : 2
								}, {
									x : 0.2904,
									y : 0.3066,
									r : 2
								}, {
									x : 0.2904,
									y : 0.3092,
									r : 2
								}, {
									x : 0.2944,
									y : 0.3190,
									r : 2
								}, {
									x : 0.2941,
									y : 0.3173,
									r : 2
								}, {
									x : 0.2905,
									y : 0.3097,
									r : 2
								}, {
									x : 0.2939,
									y : 0.3206,
									r : 2
								}, {
									x : 0.2904,
									y : 0.3113,
									r : 2
								}, {
									x : 0.2965,
									y : 0.3214,
									r : 2
								}, {
									x : 0.2908,
									y : 0.3111,
									r : 2
								}, {
									x : 0.2926,
									y : 0.3152,
									r : 2
								}, {
									x : 0.2926,
									y : 0.3129,
									r : 2
								}, {
									x : 0.2976,
									y : 0.3245,
									r : 2
								}],
								backgroundColor : "#FF6384",
								hoverBackgroundColor : "#FF6384",
							}],
						};

						var options = {
							responsive : true,
							title : {
								display : true,
								text : titleStr
							},
							elements : {
								points : {
									borderWidth : 1,
									borderColor : 'rgb(0, 0, 0)'
								}
							},
							scales : {
								xAxes : [{
									ticks : {
										suggestedMin : 0.27,
										suggestedMax : 0.32,
									}
								}],
								yAxes : [{

									ticks : {
										suggestedMin : 0.29,
										suggestedMax : 0.34,
									}
								}]
							},
						};

						var config = {
							type : 'bubble',
							data : bubbleData,
							options : options
						};

						// show average line
						var originalLineDraw = Chart.controllers.bar.prototype.draw;
						Chart.helpers.extend(Chart.controllers.bar.prototype, {
							draw : function() {
								originalLineDraw.apply(this, arguments);

								var chart = this.chart;
								var ctx = chart.chart.ctx;

								var index = chart.config.data.lineAtIndex;
								if (index) {
									var xaxis = chart.scales['x-axis-0'];
									var yaxis = chart.scales['y-axis-0'];
									ctx.fillStyle = "#0000FF";
									ctx.textAlign = "center";
									ctx.textBaseline = "bottom";
									ctx.save();
									ctx.beginPath();
									ctx.moveTo(xaxis.getPixelForValue(undefined, index), yaxis.top);
									ctx.strokeStyle = '#FF0000';
									ctx.lineTo(xaxis.getPixelForValue(undefined, index), yaxis.bottom);
									ctx.stroke();
									ctx.restore();
									ctx.fillText(avgValue, xaxis.getPixelForValue(undefined, index), yaxis.top);

								}
							}
						});

						var ctx = document.getElementById('bar-chart');
						var myChart = new Chart(ctx, config);

					},
					beforeSend : function() {
						$('#loading').show();
					},
					complete : function() {
						$('#loading').hide();
					},
					error : function() {
						alert("ERROR!!!");
					}
				});
			};

		</script>
	</body>

</html>
